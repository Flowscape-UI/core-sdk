# Исправление бага с размерами при копировании/вставке нод

## Проблема

При копировании и вставке нод (особенно из групп) их размеры откатывались к значениям по умолчанию (100x100), даже если нода была изменена в размерах.

### Причина

1. **Конструкторы нод используют значения по умолчанию:**

   ```typescript
   // ShapeNode.ts
   const shape = new Konva.Rect({
     width: options.width ?? 100, // Если width === undefined, берётся 100
     height: options.height ?? 100,
   });
   ```

2. **При десериализации в `NodeHotkeysPlugin`:**
   - Сначала создаётся нода через `this._core.nodes.addShape(config)`
   - Если в `config` нет `width/height` (или они `undefined`), применяются значения по умолчанию
   - Затем применяются трансформации (`scaleX`, `scaleY`, `rotation`)
   - **НО** если нода была изменена через трансформер, её `width/height` могли остаться исходными (100x100), а размер менялся через `scaleX/scaleY`

3. **Сценарий бага:**
   - Нода в группе: `width=100, height=100, scaleX=2, scaleY=2` (визуально 200x200)
   - При копировании сохраняются все атрибуты
   - При вставке:
     - Создаётся нода с `width=100, height=100` (из config)
     - Применяется `scaleX=2, scaleY=2`
     - Результат: визуально 200x200 ✅

   **НО** если нода была "применена" (Apply Transform):
   - Нода: `width=200, height=200, scaleX=1, scaleY=1`
   - При вставке:
     - Если `width/height` не применяются явно, конструктор может использовать значения по умолчанию
     - Результат: визуально 100x100 ❌

## Решение

### 1. Явное применение width/height перед трансформациями

В `NodeHotkeysPlugin._deserializeNode()` и `_createChildBaseNode()`:

```typescript
// ВАЖНО: Сначала применяем width/height, чтобы они не были перезаписаны значениями по умолчанию
if (data.config['width'] !== undefined) konvaNode.width(data.config['width'] as number);
if (data.config['height'] !== undefined) konvaNode.height(data.config['height'] as number);
// Затем применяем трансформации
if (data.config['scaleX'] !== undefined) konvaNode.scaleX(data.config['scaleX'] as number);
if (data.config['scaleY'] !== undefined) konvaNode.scaleY(data.config['scaleY'] as number);
// ... остальные трансформации
```

### 2. Удаление дублирования трансформаций для групп

Для групп трансформации применялись дважды:

- Внутри `case 'group'` (строки 373-386)
- В общем коде для всех нод (строки 421-428)

**Исправлено:** убрано дублирование, трансформации применяются только один раз в общем коде.

### 3. Сохранение полного трансформа при коммите временной группы

В `SelectionPlugin._commitTempMultiToGroup()` при переносе нод из временной группы в постоянную сохранялась только позиция (`getAbsolutePosition()`), но не полные трансформации (scale, rotation, skew).

**Проблема:**

- Если временная группа была трансформирована (растянута, повёрнута), дочерние ноды теряли эти трансформации
- При коммите размеры откатывались к исходным

**Решение:**

```typescript
// Сохраняем полный абсолютный трансформ (позиция + scale + rotation + skew)
const absBefore = kn.getAbsoluteTransform().copy();
g.add(kn as unknown as Konva.Group | Konva.Shape);
// Рассчитываем локальный трансформ, эквивалентный ранее абсолютному
const groupAbs = g.getAbsoluteTransform().copy();
groupAbs.invert();
const local = groupAbs.multiply(absBefore);
const d = local.decompose();
// Применяем локальные x/y/rotation/scale
```

## Изменённые файлы

- `/src/plugins/NodeHotkeysPlugin.ts`:
  - Метод `_deserializeNode()` - добавлено явное применение `width/height` перед трансформациями
  - Метод `_createChildBaseNode()` - добавлено явное применение `width/height` перед трансформациями
  - Удалено дублирование применения трансформаций для групп

- `/src/plugins/SelectionPlugin.ts`:
  - Метод `_commitTempMultiToGroup()` - исправлено сохранение полного трансформа при переносе нод из временной группы в постоянную

## Тестирование

Для проверки исправления:

1. Создать ноду (прямоугольник)
2. Добавить её в группу (Shift+Click на несколько нод, затем Ctrl+G)
3. Изменить размер группы через трансформер (растянуть)
4. Вырезать ноду из группы (Ctrl+X)
5. Вставить в другом месте (Ctrl+V)
6. **Проверить:** размер ноды должен остаться таким же, как был в группе

Также проверить:

- Копирование/вставку одиночных нод
- Копирование/вставку временных групп (Shift+Click)
- Копирование/вставку постоянных групп (Ctrl+G)
- Копирование/вставку нод с применёнными трансформациями (Apply Transform)

### Дополнительные тест-кейсы:

**Тест 1: Временная группа → трансформация → коммит в постоянную группу**

1. Выделить несколько нод (Shift+Click)
2. Растянуть временную группу через трансформер
3. Закоммитить в постоянную группу (Ctrl+G)
4. **Проверить:** размеры нод в группе должны сохраниться

**Тест 2: Постоянная группа → трансформация → разгруппировка**

1. Создать группу (Ctrl+G)
2. Растянуть группу через трансформер
3. Разгруппировать (Ctrl+Shift+G)
4. **Проверить:** размеры нод должны остаться растянутыми

**Тест 3: Нода в группе → трансформация группы → вырезание → вставка**

1. Создать группу с нодой
2. Растянуть группу в 2 раза
3. Вырезать ноду из группы (Ctrl+X)
4. Вставить (Ctrl+V)
5. **Проверить:** нода должна быть в 2 раза больше исходного размера

**Тест 4: Вложенные группы**

1. Создать группу с нодами
2. Создать ещё одну группу, включающую первую группу
3. Трансформировать внешнюю группу
4. Копировать/вставить (Ctrl+C, Ctrl+V)
5. **Проверить:** все размеры и вложенность сохранены
